## 通信模块技术文档 (P2P Modules Technical Document)

### 通信模块简介
* 该模块需要完成点对点通信任务。
* 为了达到去中心化目的，通信模块使用单纯型P2P技术。

### P2P技术概述
* 依赖中心服务的P2P
    >有专用的服务器，服务器作为索引服务器，混合型P2P系统中的索引服务器仅仅起到协调和扩展的功能，在索引服务器的协调下，各个设备间可进行P2P通信。</br>
    与C/S架构不同，C/S架构所有传递的信息都要经过服务器转发。
    * 原理简介
        1. 有一个拥有公网IP的节点——服务器，用来存储所有在线客户端的IP和端口信息。
        2. 每个客户端上线时，使用UDP向专用服务器发送一包数据，表示自己上线。
        3. 服务器记录客户端上线发送数据时所使用的IP和端口。
            >绝大部分情况下客户端在内网，当数据包经过出口路由时，路由上的NAT会修改数据包的发送方IP和端口修改为公网IP和随机端口，并在NAT上创建一个Session，该Session包含公网IP端口到客户端A IP口的映射</br>
            服务端记录的将是公网出口路由转发数据时使用的IP和端口，但因为路由NAT中Session的存在，给客户端公网IP和端口发送数据，路由会把数据转发给客户端A</br>
            这个Session是有时效性的，一般最小值大概在100秒左右。如果Session失效，路由接受到的数据包就是不经过认证的，一般的路由会做丢弃的操作。所以需要定时发送心跳包，让Session不失效。
        4. 当客户端A要与客户端B通信时，客户端A从服务器获取客户端B的IP和端口信息，客户端A即可直接向客户端B发送数据，客户B也可直接给A发送数据，从而达到P2P通信。
        5. 参考图：![image](https://raw.githubusercontent.com/freemanpeng/VOS/master/images/Mixedp2p.png)
* 不依赖中心服务的P2P
    >不需要专用的服务器，安装了P2P软件的各个设备可以发现其他节点并直接通信。
    * 原理简介
        * 1.每个节点都存储其它节点地址信息，在全网节点数量较少的情况下，每个节点存储所有其他节点的地址信息，当全网节点数量较多的情况下存储部分节点的地址信息。
        * 2.每个节点上线时，通知其他节点(发送自己的新地址)，并从其他节点获取，最新其他节点地址信息。
        * 3.当客户端A 要与客户端B 通信时，A从本地获取B的IP和端口信息，并向B发送数据，B收到数据后通知A，在一定时间内，A如果接收不到通知，则认为B节点没有接受到消息。
        * 4.当A认为B没有接收到数据，则A向其他节点查询B的新地址，并向B的新地址发送数据。如果B没有新地址，则有两种可能：1.B节点下线；2.网络问题。
        * 5.如果A向B发送数据，B接收到数据后通知A；B向A发送数据，A接受到数据后通知B，则可完成P2P通信。
        * 6. 参考图：
            
### P2P 概念词解释
*`Friend VOS`：`VOS`用户可以指定N个`VOS`节点，作为自己的`Friend VOS`，对方同意后，建立起好友关系，好友不在线时，帮助好友接收数据。`Friend VOS`有`VOS`的签名，可以被验证。
*`VOS Map`：本地存储所有其它`VOS`节点地址信息的一个文件。
>一个应用场景举例：在系统用户量较少的情况下，用户可以购买一台硬件设备放置在某地(或使用一台旧的智能手机)，作为自己的一个`Friend VOS`，即可接收离线信息。

### 模块功能
* 该模块需要在没有中心化服务器的前提下完成以下功能：
    * 每个`VOS`节点都可以给其他`VOS`节点发送在线消息和离线消息。
    * 发送数据后，可以确认消息是否被接收。
    * 对开发者提供API：
        * 判断指定地址是否在在线。
        * 向指定的地址发送数据。

### 模块流程
* 节点第一次上线时，需要某个在线`VOS`节点地址作为参数，从该节点获取其他节点地址信息(每个节点都存储所有节点信息)，并向所有在线其他节点发送自己的地址。
* 每个节点上线(或地址有变动)时，发送自己的地址，通知其它在线节点更新`VOS Map`。
* A节点给B节点发送信息，根据地址可以计算出ip和端口。发送信息流程如下:</br>


    if B在线
        直接发送给B，发送成功
    if B不在线
        if B的`Friend VOS`节点在线
            发送给`Friend VOS`，好友代收
        else
            发送失败
>注：每个节点都存储所有节点信息：所有节点应该构成一个连通图，为了避免节点下线，导致分裂为两个连通图，所以存储有节点的地址。</br>
    每个节点上线时，通知其它在线节点更新`VOS Map`。</br>
    这条设计可优化。</br>
    NAT穿透时，对称型vs对称型、端口限制锥型vs对称型不能穿透，所以需要选择一个锥型NAT来中转数据。
### 模块设计
* `VOS Map` 每条地址信息包含的字段：
    * 地址、名字、公钥、`Friend VOS`地址...
* 类
* 测试